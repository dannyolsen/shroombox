<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Shroombox Control Panel</title>

    <!-- Load Alpine.js and Tailwind directly -->
    <script src="https://unpkg.com/alpinejs@3.12.0/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/main.js"></script>

    <script>
        document.addEventListener('alpine:init', () => {
            console.log('Alpine.js initialized successfully');
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof Alpine === 'undefined') {
                console.error('Alpine.js failed to load.');
            }
        });
    </script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
    <div x-data="controlPanel()" x-init="init()" class="max-w-6xl mx-auto space-y-6">
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Shroombox Control Panel</h1>
        </div>

        <!-- Environment Controls -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Environment Controls</h2>
                <div class="flex items-center">
                    <label class="block text-sm font-medium text-gray-700 mr-2">Growth Phase:</label>
                    <select 
                        id="phase-select"
                        x-model="currentPhase" 
                        @change="updatePhase"
                        class="rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                    >
                        <option value="colonisation">Colonisation</option>
                        <option value="growing">Growing</option>
                        <option value="cake">Cake</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-6">
                <!-- Temperature Column -->
                <div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Temperature</label>
                        <div class="text-2xl font-medium" x-text="measurements.temperature + ' °C'"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Setpoint (°C)</label>
                        <input 
                            type="number" 
                            class="block w-24 rounded-md border border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2"
                            step="0.1"
                            x-model="setpoints.temperature"
                            @change="updateSetpoint('temperature')"
                            min="0"
                            max="40"
                        >
                    </div>
                </div>

                <!-- CO2 Column -->
                <div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">CO2</label>
                        <div class="text-2xl font-medium" x-text="measurements.co2 + ' ppm'"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Setpoint (ppm)</label>
                        <input 
                            type="number" 
                            class="block w-24 rounded-md border border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2"
                            step="10"
                            x-model="setpoints.co2"
                            @change="updateSetpoint('co2')"
                            min="0"
                            max="20000"
                        >
                    </div>
                </div>

                <!-- Humidity Column -->
                <div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Humidity</label>
                        <div class="text-2xl font-medium" x-text="measurements.humidity + ' %'"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Setpoint (%)</label>
                        <input 
                            type="number" 
                            class="block w-24 rounded-md border border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2"
                            step="1"
                            x-model="setpoints.humidity"
                            @change="updateSetpoint('humidity')"
                            min="0"
                            max="100"
                        >
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Settings -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Device Settings</h2>
                <button 
                    @click="rescanDevices"
                    class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                    :class="{'opacity-50 cursor-not-allowed': isScanning}"
                    :disabled="isScanning"
                >
                    <!-- Spinner for loading state -->
                    <svg x-show="isScanning" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span x-text="isScanning ? 'Scanning...' : 'Scan for Devices'"></span>
                </button>
            </div>
            <div class="grid grid-cols-2 gap-6">
                <!-- Heater Section -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-700">Heater</h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select Device</label>
                        <select 
                            x-model="selectedHeater"
                            @change="updateDeviceRole('heater')"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 mb-2"
                        >
                            <option value="">Select a device...</option>
                            <template x-for="device in availableDevices" :key="device.ip">
                                <option 
                                    :value="device.ip"
                                    x-text="device.name"
                                ></option>
                            </template>
                        </select>
                        <!-- Heater Device Info -->
                        <div x-show="selectedHeater" class="mt-2 text-sm space-y-1 text-gray-600 bg-gray-50 p-3 rounded-md">
                            <template x-for="device in availableDevices" :key="device.ip">
                                <div x-show="device.ip === selectedHeater">
                                    <div><span class="font-medium">IP:</span> <span x-text="device.ip"></span></div>
                                    <div><span class="font-medium">MAC:</span> <span x-text="device.mac"></span></div>
                                    <div><span class="font-medium">Model:</span> <span x-text="device.model"></span></div>
                                    <div><span class="font-medium">Type:</span> <span x-text="device.type"></span></div>
                                    <div class="space-y-1">
                                        <div class="flex items-center">
                                            <span class="text-sm text-gray-600 mr-2">Status:</span>
                                            <span 
                                                :class="getDeviceStatusClass(device)"
                                                x-text="getDeviceStatusText(device)"
                                            ></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Humidifier Section -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-700">Humidifier</h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select Device</label>
                        <select 
                            x-model="selectedHumidifier"
                            @change="updateDeviceRole('humidifier')"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 mb-2"
                        >
                            <option value="">Select a device...</option>
                            <template x-for="device in availableDevices" :key="device.ip">
                                <option 
                                    :value="device.ip"
                                    x-text="device.name"
                                ></option>
                            </template>
                        </select>
                        <!-- Humidifier Device Info -->
                        <div x-show="selectedHumidifier" class="mt-2 text-sm space-y-1 text-gray-600 bg-gray-50 p-3 rounded-md">
                            <template x-for="device in availableDevices" :key="device.ip">
                                <div x-show="device.ip === selectedHumidifier">
                                    <div><span class="font-medium">IP:</span> <span x-text="device.ip"></span></div>
                                    <div><span class="font-medium">MAC:</span> <span x-text="device.mac"></span></div>
                                    <div><span class="font-medium">Model:</span> <span x-text="device.model"></span></div>
                                    <div><span class="font-medium">Type:</span> <span x-text="device.type"></span></div>
                                    <div class="space-y-1">
                                        <div class="flex items-center">
                                            <span class="text-sm text-gray-600 mr-2">Status:</span>
                                            <span 
                                                :class="getDeviceStatusClass(device)"
                                                x-text="getDeviceStatusText(device)"
                                            ></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">System Status</h2>
                <div class="flex items-center">
                    <div 
                        class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800"
                    >
                        <span class="mr-2">●</span>
                        <span>System Active</span>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-600">Fan Speed</div>
                    <div class="text-lg font-medium" x-text="systemStatus.fan_speed + '%'"></div>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-600">Heater</div>
                    <div 
                        class="text-lg font-medium"
                        :class="{'text-green-600': systemStatus.heater.state, 'text-gray-600': !systemStatus.heater.state}"
                        x-text="systemStatus.heater.text"
                    ></div>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-600">Humidifier</div>
                    <div 
                        class="text-lg font-medium"
                        :class="{'text-green-600': systemStatus.humidifier.state, 'text-gray-600': !systemStatus.humidifier.state}"
                        x-text="systemStatus.humidifier.text"
                    ></div>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-600">CPU Temp</div>
                    <div class="text-lg font-medium" x-text="(systemStatus.cpu_temp ?? '--') + '°C'"></div>
                </div>
            </div>
        </div>

        <!-- Terminal Output -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Terminal Output</h2>
            <div 
                id="terminal-output" 
                class="font-mono text-sm bg-black text-green-400 p-4 rounded-lg h-96 overflow-y-auto"
                style="white-space: pre-wrap; line-height: 1.4;"
            >
            </div>
        </div>
    </div>

    <script>
        function controlPanel() {
            return {
                currentPhase: 'colonisation',
                measurements: { temperature: '--', humidity: '--', co2: '--' },
                setpoints: { temperature: 0, humidity: 0, co2: 0 },
                availableDevices: [],
                selectedHeater: '',
                selectedHumidifier: '',
                isScanning: false,
                systemStatus: {
                    fan_speed: 0,
                    heater: { state: false, text: 'OFF' },
                    humidifier: { state: false, text: 'OFF' },
                    cpu_temp: null
                },
                eventSource: null,

                init() {
                    this.loadCurrentPhase();
                    this.loadSetpoints();
                    this.updateMeasurements();
                    this.loadAvailableDevices();
                    this.initTerminal();

                    setInterval(() => {
                        this.updateMeasurements();
                        this.updateSystemStatus();
                    }, 5000);
                },

                async loadCurrentPhase() {
                    try {
                        const response = await fetch('/api/settings');
                        const data = await response.json();
                        this.currentPhase = data.environment.current_phase;
                    } catch (error) {
                        console.error('Error loading current phase:', error);
                    }
                },

                async updatePhase() {
                    try {
                        const response = await fetch('/api/settings');
                        const settings = await response.json();
                        settings.environment.current_phase = this.currentPhase;

                        const saveResponse = await fetch('/api/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(settings)
                        });

                        if (!saveResponse.ok) {
                            throw new Error('Failed to update phase');
                        }

                        await this.loadSetpoints();
                        console.log(`Updated growth phase to: ${this.currentPhase}`);
                    } catch (error) {
                        console.error('Error updating phase:', error);
                        alert('Failed to update growth phase');
                        await this.loadCurrentPhase(); // revert if failed
                    }
                },

                async loadSetpoints() {
                    try {
                        const response = await fetch('/api/settings');
                        const data = await response.json();
                        const phaseSettings = data.environment.phases[this.currentPhase];

                        this.setpoints = {
                            temperature: parseFloat(phaseSettings.temp_setpoint) || 23,
                            humidity: parseFloat(phaseSettings.rh_setpoint) || 60,
                            co2: parseInt(phaseSettings.co2_setpoint) || 10000
                        };
                        
                        console.log("Loaded setpoints:", this.setpoints);
                    } catch (error) {
                        console.error('Error loading setpoints:', error);
                    }
                },

                async updateSetpoint(type) {
                    try {
                        const response = await fetch('/api/settings');
                        const settings = await response.json();
                        
                        // Map frontend field names to backend field names
                        const fieldMapping = {
                            'temperature': 'temp_setpoint',
                            'humidity': 'rh_setpoint',
                            'co2': 'co2_setpoint'
                        };
                        
                        // Get the correct field name for the backend
                        const fieldName = fieldMapping[type];
                        if (!fieldName) {
                            throw new Error(`Unknown setpoint type: ${type}`);
                        }
                        
                        // Update the setpoint in the settings object
                        settings.environment.phases[this.currentPhase][fieldName] = this.setpoints[type];
                        
                        // Save the updated settings
                        const saveResponse = await fetch('/api/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(settings)
                        });

                        if (!saveResponse.ok) {
                            throw new Error('Failed to save setpoint');
                        }

                        console.log(`Updated ${type} setpoint to ${this.setpoints[type]}`);
                    } catch (error) {
                        console.error('Error updating setpoint:', error);
                        alert('Failed to update setpoint');
                    }
                },

                async updateMeasurements() {
                    try {
                        const response = await fetch('/api/measurements/latest');
                        const data = await response.json();

                        if (response.ok) {
                            this.measurements = {
                                temperature: data.temperature ?? '--',
                                humidity: data.humidity ?? '--',
                                co2: data.co2 ?? '--'
                            };
                        } else {
                            console.error('Error fetching measurements:', data.error);
                        }
                    } catch (error) {
                        console.error('Error updating measurements:', error);
                    }
                },

                async loadAvailableDevices() {
                    try {
                        const response = await fetch('/api/settings');
                        const data = await response.json();
                        
                        if (data.available_devices && Array.isArray(data.available_devices)) {
                            this.availableDevices = data.available_devices;
                            console.log("Loaded available devices:", this.availableDevices);
                            
                            // Set selected devices based on roles
                            this.availableDevices.forEach(device => {
                                if (device.role === 'heater') {
                                    this.selectedHeater = device.ip;
                                } else if (device.role === 'humidifier') {
                                    this.selectedHumidifier = device.ip;
                                }
                            });
                        } else {
                            console.error("No available_devices found in settings");
                        }
                    } catch (error) {
                        console.error('Error loading available devices:', error);
                    }
                },

                async updateDeviceRole(role) {
                    try {
                        const response = await fetch('/api/settings');
                        const settings = await response.json();
                        
                        // Get the selected IP based on role
                        const selectedIp = role === 'heater' ? this.selectedHeater : this.selectedHumidifier;
                        
                        if (!selectedIp) {
                            console.log(`No device selected for ${role}`);
                            return;
                        }
                        
                        // Update role for the selected device and remove from other devices
                        settings.available_devices.forEach(device => {
                            if (device.ip === selectedIp) {
                                device.role = role;
                            } else if (device.role === role) {
                                device.role = null; // Remove role from other devices
                            }
                        });
                        
                        // Save updated settings
                        const saveResponse = await fetch('/api/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(settings)
                        });
                        
                        if (!saveResponse.ok) {
                            throw new Error(`Failed to update ${role} assignment`);
                        }
                        
                        console.log(`Updated ${role} assignment to device at ${selectedIp}`);
                    } catch (error) {
                        console.error(`Error updating ${role} assignment:`, error);
                        alert(`Failed to update ${role} assignment`);
                    }
                },

                async rescanDevices() {
                    try {
                        this.isScanning = true;
                        
                        const response = await fetch('/api/devices/scan', {
                            method: 'POST'
                        });
                        
                        if (!response.ok) {
                            throw new Error('Device scan failed');
                        }
                        
                        // Reload available devices after scan
                        await this.loadAvailableDevices();
                        
                        this.isScanning = false;
                        console.log("Device scan completed");
                    } catch (error) {
                        console.error('Error during device scan:', error);
                        alert('Device scan failed');
                        this.isScanning = false;
                    }
                },

                getDeviceStatusClass(device) {
                    return device.state ? 
                        'px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800' : 
                        'px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800';
                },
                
                getDeviceStatusText(device) {
                    return device.state ? 'ON' : 'OFF';
                },

                async updateSystemStatus() {
                    try {
                        const response = await fetch('/api/system/status');
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.systemStatus = {
                                fan_speed: data.fan_speed || 0,
                                heater: { 
                                    state: data.heater || false, 
                                    text: data.heater ? 'ON' : 'OFF' 
                                },
                                humidifier: { 
                                    state: data.humidifier || false, 
                                    text: data.humidifier ? 'ON' : 'OFF' 
                                },
                                cpu_temp: data.cpu_temp
                            };
                        }
                    } catch (error) {
                        console.error('Error updating system status:', error);
                    }
                },

                initTerminal() {
                    const terminalOutput = document.getElementById('terminal-output');
                    if (!terminalOutput) return;
                    
                    // Set up EventSource for terminal updates
                    try {
                        this.eventSource = new EventSource('/api/logs/stream');
                        
                        this.eventSource.onmessage = (event) => {
                            const logLine = event.data;
                            terminalOutput.innerHTML += logLine + '\n';
                            terminalOutput.scrollTop = terminalOutput.scrollHeight;
                        };
                        
                        this.eventSource.onerror = (error) => {
                            console.error('EventSource error:', error);
                            this.eventSource.close();
                            
                            // Try to reconnect after a delay
                            setTimeout(() => this.initTerminal(), 5000);
                        };
                    } catch (error) {
                        console.error('Error setting up EventSource:', error);
                    }
                }
            };
        }
    </script>
</body>
</html> 