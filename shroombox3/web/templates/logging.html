<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Shroombox - Logging Control</title>

    <!-- Load Alpine.js and Tailwind directly -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/main.js"></script>

    <style>
        [x-cloak] { display: none !important; }
        
        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Debug panel */
        #debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 9999;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 z-50 flex flex-col items-center justify-center">
        <div class="spinner mb-4"></div>
        <p class="text-lg font-medium text-gray-800 mb-2">Loading Logging Control...</p>
        <p class="text-sm text-gray-600">This may take a few moments</p>
        <p id="loading-error" class="mt-4 text-red-600 hidden"></p>
    </div>

    <!-- Debug Panel -->
    <div id="debug-panel" class="hidden">
        <div>Debug Panel:</div>
        <div id="debug-log"></div>
    </div>

    <div class="container mx-auto p-6" x-data="loggingControl()" x-init="init()">
        <h1 class="text-4xl font-bold mb-6 text-center">Logging Control Panel</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Logging Levels Section -->
            <div class="bg-white shadow-lg rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Logging Levels</h2>
                <div class="space-y-3">
                    <template x-for="logger in loggers" :key="logger.name">
                        <div class="flex items-center justify-between">
                            <span x-text="logger.name" class="font-medium"></span>
                            <select x-model="logger.level" class="border rounded px-3 py-1 bg-gray-50">
                                <option value="DEBUG">DEBUG</option>
                                <option value="INFO">INFO</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                                <option value="CRITICAL">CRITICAL</option>
                            </select>
                        </div>
                    </template>
                    <button @click="applyAll(); alert('Logging levels applied successfully!');" class="mt-4 w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-200">Apply to All Loggers</button>
                </div>
            </div>

            <!-- Log Viewer Section -->
            <div class="bg-white shadow-lg rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Real-Time Log Viewer</h2>
                <div class="overflow-auto h-72 bg-gray-900 text-green-300 p-3 rounded">
                    <template x-for="entry in logEntries" :key="entry">
                        <div x-text="entry" class="text-sm"></div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Debug Panel Toggle -->
        <div class="mt-6 text-center">
            <button @click="toggleDebug()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition duration-200">Toggle Debug Panel</button>
        </div>

        <!-- Enhanced Debug Panel -->
        <div x-show="debug" class="mt-6 bg-gray-800 text-white p-4 rounded shadow-lg">
            <h3 class="font-semibold text-lg mb-2">Debug Information</h3>
            <pre x-text="JSON.stringify(debugInfo, null, 2)" class="text-xs overflow-auto"></pre>
        </div>
    </div>

    <script>
        // Debug logging function
        function debugLog(message, type = 'info') {
            const debugLog = document.getElementById('debug-log');
            if (!debugLog) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type === 'error' ? 'text-red-400' : (type === 'warning' ? 'text-yellow-400' : 'text-green-400');
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            debugLog.appendChild(logEntry);
            console.log(`[${type}] ${message}`);
            
            // Keep only the last 50 entries
            while (debugLog.children.length > 50) {
                debugLog.removeChild(debugLog.firstChild);
            }
        }

        // Add a fallback for Alpine.js in case the CDN fails
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (typeof Alpine === 'undefined') {
                    console.error('Alpine.js failed to load from CDN, loading fallback');
                    const fallbackScript = document.createElement('script');
                    fallbackScript.src = 'https://cdn.jsdelivr.net/npm/alpinejs@3.12.0/dist/cdn.min.js';
                    document.head.appendChild(fallbackScript);
                }
                
                // Add a safety timeout to hide the loading overlay after 10 seconds
                setTimeout(function() {
                    const loadingOverlay = document.getElementById('loading-overlay');
                    if (loadingOverlay && !loadingOverlay.classList.contains('hidden')) {
                        console.warn('Loading timeout reached, forcing overlay removal');
                        loadingOverlay.classList.add('hidden');
                    }
                }, 10000);
            }, 1000);
        });

        // Track loading state
        let alpineLoaded = false;
        
        document.addEventListener('alpine:init', () => {
            console.log('Alpine.js initialized successfully');
            alpineLoaded = true;
            hideLoadingOverlay();
        });

        function hideLoadingOverlay() {
            if (alpineLoaded) {
                console.log('All resources loaded successfully');
                setTimeout(() => {
                    const loadingOverlay = document.getElementById('loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.classList.add('hidden');
                    }
                }, 500);
            }
        }

        function loggingControl() {
            return {
                loggers: [],
                logEntries: [],
                debug: false,
                debugInfo: {},
                init() {
                    this.fetchLoggers();
                    this.fetchLogs();
                },
                fetchLoggers() {
                    fetch('/api/loggers').then(res => res.json()).then(data => this.loggers = data);
                },
                fetchLogs() {
                    fetch('/api/logs').then(res => res.json()).then(data => this.logEntries = data);
                },
                applyAll() {
                    const level = this.loggers[0].level;
                    this.loggers.forEach(logger => logger.level = level);
                    fetch('/api/loggers', {method: 'POST', body: JSON.stringify(this.loggers)});
                },
                toggleDebug() {
                    this.debug = !this.debug;
                    this.debugInfo = {loggers: this.loggers, entries: this.logEntries};
                }
            }
        }
    </script>
</body>
</html> 